# ESP32 AWS IoT Core Device

A simplified Arduino implementation for ESP32-C3 devices to connect to AWS IoT Core with MQTT communication and built-in sensor monitoring.

## Overview

This ESP32-C3 Arduino project provides a clean, reliable solution for connecting to AWS IoT Core. It includes automatic WiFi connection, secure MQTT communication, and comprehensive system monitoring using only built-in hardware.

### Key Features

- **Secure AWS IoT Core Connection**: Mutual TLS authentication with X.509 certificates
- **Built-in Sensor Monitoring**: Temperature, WiFi signal, memory usage, and system information
- **MQTT Communication**: Publish sensor data and receive commands
- **Auto-reconnection**: Automatic reconnection on network failures
- **Configurable Features**: Enable/disable diagnostic functions as needed
- **Modular Design**: Clean separation of AWS and device configuration

## Hardware Requirements

- **ESP32-C3** microcontroller
- **WiFi connection** for internet access
- **No external sensors required** - uses built-in capabilities

## Software Requirements

- **Arduino IDE** (1.8.19 or later)
- **ESP32 Arduino Core** (2.0.0 or later)
- **Required Libraries**:
  - WiFi (built-in)
  - WiFiClientSecure (built-in)
  - PubSubClient
  - ArduinoJson

## Installation

1. **Clone the repository**
2. **Install required libraries** in Arduino IDE:
   - PubSubClient by Nick O'Leary
   - ArduinoJson by Benoit Blanchon
3. **Configure WiFi** in `wifi_config.h`
4. **Generate AWS config** using Terraform (see Configuration section)
5. **Upload to ESP32-C3**

## Configuration

### WiFi Configuration

Edit `wifi_config.h`:

```cpp
const char* WIFI_SSID = "YourWiFiNetwork";
const char* WIFI_PASSWORD = "YourWiFiPassword";
```

### AWS Configuration

The AWS configuration is generated by Terraform and stored in `aws_config.h`:

- AWS IoT endpoint
- Thing name
- X.509 certificates (device, CA, private key)
- MQTT settings

### Device Configuration

Edit `device_config.h` to customize:

```cpp
// Timing intervals
const unsigned long DATA_PUBLISH_INTERVAL = 5000;     // 5 seconds
const unsigned long HEARTBEAT_INTERVAL = 30000;       // 30 seconds

// Feature switches
const bool ENABLE_TEMPERATURE_SENSOR = true;          // Built-in temperature
const bool ENABLE_CONNECTION_MONITORING = true;       // Connection monitoring
const bool ENABLE_GRACEFUL_RECONNECTION = true;       // Auto-reconnection
const bool ENABLE_ERROR_DIAGNOSTICS = true;           // Error logging
```

## Usage

### Data Published

The device publishes comprehensive system data every 5 seconds to `{THING_NAME}/pub`:

```json
{
  "device_id": "basic-device",
  "timestamp": 12345,
  "temperature": 25.6,           // Built-in temperature sensor
  "wifi_rssi": -50,              // WiFi signal strength
  "wifi_ssid": "YourWiFi",       // WiFi network name
  "free_heap": 153840,           // Available RAM
  "uptime": 30,                  // Seconds since boot
  "mqtt_connected": true,        // Connection status
  "cpu_freq": 160,               // CPU frequency (MHz)
  "flash_size": 4194304,         // Flash size (bytes)
  "chip_model": "ESP32-C3",      // Chip model
  "chip_revision": 3             // Hardware revision
}
```

### MQTT Topics

- **`{THING_NAME}/pub`** - Sensor data and system information
- **`{THING_NAME}/heartbeat`** - Heartbeat messages (every 30s)
- **`{THING_NAME}/status`** - Device status (every 15s)
- **`{THING_NAME}/sub`** - Commands from cloud

### Commands

Send JSON commands to `{THING_NAME}/sub`:

```json
{
  "command": "led",
  "state": "on"
}
```

```json
{
  "command": "status"
}
```

## Built-in Capabilities

### Sensors

- **Temperature**: Internal chip temperature via `temperatureRead()`
- **WiFi Signal**: RSSI strength and network information
- **Memory**: Free heap monitoring
- **System**: CPU frequency, flash size, chip model/revision

### Features

- **Connection Monitoring**: Automatic connection status checking
- **Graceful Reconnection**: 30-second cooldown between reconnection attempts
- **Error Diagnostics**: Detailed error logging (configurable)
- **DNS Checking**: Network connectivity validation
- **Certificate Validation**: Certificate integrity checking

## Testing

### AWS IoT Console

1. **Subscribe to topics**:
   - `basic-device/pub` - Sensor data
   - `basic-device/heartbeat` - Heartbeat messages
   - `basic-device/status` - Device status

2. **Send commands** to `basic-device/sub`:

   ```json
   {"command": "led", "state": "on"}
   ```

### Serial Monitor

Open Serial Monitor (115200 baud) to see:

```plaintext
ðŸ”§ Setting up sensors...
  âœ… Temperature sensor enabled (Built-in)
ðŸ”§ Sensor setup complete!
Connecting to Wi-Fi
âœ… WiFi connected!
âœ… MQTT connected!
âœ“ Data published to: basic-device/pub
```

## Troubleshooting

### Common Issues

1. **WiFi Connection Failed**
   - Check credentials in `wifi_config.h`
   - Verify network availability

2. **MQTT Connection Failed**
   - Check AWS certificates in `aws_config.h`
   - Verify AWS IoT endpoint
   - Check Terraform policy permissions

3. **No Data Published**
   - Check Serial Monitor for error messages
   - Verify MQTT connection status
   - Check topic permissions in AWS IoT policy

### Debug Information

Enable error diagnostics in `device_config.h`:

```cpp
const bool ENABLE_ERROR_DIAGNOSTICS = true;
```

## File Structure

```plaintext
esp32-aws-iot/
â”œâ”€â”€ esp32-aws-iot.ino          # Main Arduino sketch
â”œâ”€â”€ device_config.h            # Device configuration
â”œâ”€â”€ aws_config.h              # AWS configuration (from Terraform)
â”œâ”€â”€ wifi_config.h             # WiFi credentials
â”œâ”€â”€ aws_config_template.h     # AWS config template
â”œâ”€â”€ wifi_config_template.h    # WiFi config template
â”œâ”€â”€ generate_aws_config.sh    # AWS config generation script
â”œâ”€â”€ generate_aws_config.ps1   # Windows AWS config generation
â””â”€â”€ .vscode/                  # VS Code configuration
```

## Configuration Files

### `device_config.h`

- Device-specific settings
- Timing intervals
- Feature enable/disable switches
- Sensor configuration

### `aws_config.h`

- AWS IoT endpoint and certificates
- MQTT settings
- Generated by Terraform

### `wifi_config.h`

- WiFi network credentials
- Created from template

## License

This project is licensed under the MIT License - see the LICENSE file for details.
